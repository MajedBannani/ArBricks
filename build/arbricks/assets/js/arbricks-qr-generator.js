/**
 * ArBricks QR Generator Logic
 */
(function($) {
    'use strict';

    $(document).ready(function() {
        const $urlInput = $('#arbricks-qr-url');
        const $sizeSelect = $('#arbricks-qr-size');
        const $generateBtn = $('#arbricks-qr-generate');
        const $downloadBtn = $('#arbricks-qr-download');
        const $output = $('#arbricks-qr-output');

        let qrcode = null;

        $generateBtn.on('click', function(e) {
            e.preventDefault();

            const url = $urlInput.val().trim();
            const size = parseInt($sizeSelect.val(), 10);

            if (!url) {
                alert(arbricksQRGenerator.error_no_url || 'Please enter a URL');
                return;
            }

            // Clear output and show loading or something similar if needed
            $output.empty();

            // Initialize QRCode
            // The library creates a canvas or image inside the provided element
            qrcode = new QRCode($output[0], {
                text: url,
                width: size,
                height: size,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            // Show download button
            $downloadBtn.show();
        });

        $downloadBtn.on('click', function(e) {
            e.preventDefault();

            // Try to find the image generated by QRCode.js
            const $img = $output.find('img');
            const $canvas = $output.find('canvas');
            
            let dataURL = '';

            if ($img.length && $img.attr('src')) {
                dataURL = $img.attr('src');
            } else if ($canvas.length) {
                dataURL = $canvas[0].toDataURL("image/png");
            }

            if (dataURL) {
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = 'arbricks-qr-code.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });
    });

})(jQuery);
