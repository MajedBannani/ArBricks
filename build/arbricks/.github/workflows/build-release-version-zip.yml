name: Build Release ZIP (arbricks-vX.Y.Z.zip + root folder arbricks/)

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build_zip:
    runs-on: ubuntu-latest

    env:
      PLUGIN_SLUG: arbricks
      MAIN_FILE: arbricks.php

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Derive version + zip name from tag (vX.Y.Z)
        id: ver
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          ZIP_NAME="${{ env.PLUGIN_SLUG }}-v${VERSION}.zip"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

          echo "Release tag: $TAG"
          echo "Normalized version: $VERSION"
          echo "ZIP name: $ZIP_NAME"

      - name: Prepare dist folder (stable root folder = slug)
        run: |
          rm -rf dist
          mkdir -p "dist/${{ env.PLUGIN_SLUG }}"

          rsync -av --delete \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="node_modules" \
            --exclude="tests" \
            --exclude="phpunit.xml" \
            --exclude="phpcs.xml" \
            --exclude="*.map" \
            --exclude="*.log" \
            --exclude=".DS_Store" \
            ./ "dist/${{ env.PLUGIN_SLUG }}/"

      - name: Update plugin header Version inside dist (force replace)
        run: |
          FILE="dist/${{ env.PLUGIN_SLUG }}/${{ env.MAIN_FILE }}"
          VERSION="${{ steps.ver.outputs.version }}"

          if [ ! -f "$FILE" ]; then
            echo "ERROR: Main plugin file not found: $FILE"
            exit 1
          fi

          echo "Before update:"
          grep -n -i "version" "$FILE" | head -n 5 || true

          # Replace ANY Version header format safely
          perl -0777 -i -pe "s/\*[\s]*Version[\s]*:[\s]*[0-9\.]+/* Version: ${VERSION}/i" "$FILE"

          echo "After update:"
          grep -n -i "version" "$FILE" | head -n 5 || true

      - name: Verify Version before ZIP
        run: |
          FILE="dist/${{ env.PLUGIN_SLUG }}/${{ env.MAIN_FILE }}"
          echo "Final Version header:"
          grep -nE "^\s*\*\s*Version" "$FILE" || true

      - name: Create ZIP (root folder must be arbricks/)
        run: |
          cd dist
          zip -r "${{ steps.ver.outputs.zip_name }}" "${{ env.PLUGIN_SLUG }}"

      - name: Validate ZIP root folder name (must be arbricks/)
        run: |
          ZIP_PATH="dist/${{ steps.ver.outputs.zip_name }}"
          ROOT="$(unzip -Z -1 "$ZIP_PATH" | head -n 1)"
          echo "ZIP first entry: $ROOT"

          case "$ROOT" in
            "${{ env.PLUGIN_SLUG }}/"*) echo "OK: Root folder is ${{ env.PLUGIN_SLUG }}/" ;;
            *) echo "ERROR: ZIP root folder is not ${{ env.PLUGIN_SLUG }}/"; exit 1 ;;
          esac

      - name: Delete existing asset with same name (if any)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const release_id = context.payload.release.id;
            const assetName = "${{ steps.ver.outputs.zip_name }}";

            const assets = await github.rest.repos.listReleaseAssets({ owner, repo, release_id });
            const existing = assets.data.find(a => a.name === assetName);

            if (existing) {
              await github.rest.repos.deleteReleaseAsset({ owner, repo, asset_id: existing.id });
              core.info(`Deleted existing asset: ${assetName}`);
            } else {
              core.info(`No existing asset named: ${assetName}`);
            }

      - name: Upload ZIP as Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: dist/${{ steps.ver.outputs.zip_name }}
          asset_name: ${{ steps.ver.outputs.zip_name }}
          asset_content_type: application/zip
